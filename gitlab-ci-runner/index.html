<!DOCTYPE html><html data-saber-ssr><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta http-equiv="X-UA-Compatible" content="ie=edge" /><meta data-saber-head="ssr" name="generator" content="Saber v0.11.3"><meta data-saber-head="ssr" name="og:site_name" content="Randy&#x27;s Blog"><meta data-saber-head="ssr" property="title" content="搭建自己的 Gitlab CI Runner - Randy&#x27;s Blog"><meta data-saber-head="ssr" property="description" content="&lt;p&gt;假定你已经有一台可用的，可联网的机器&lt;/p&gt;
"><meta data-saber-head="ssr" property="og:description" content="&lt;p&gt;假定你已经有一台可用的，可联网的机器&lt;/p&gt;
"><meta data-saber-head="ssr" property="twitter:description" content="&lt;p&gt;假定你已经有一台可用的，可联网的机器&lt;/p&gt;
"><meta data-saber-head="ssr" property="og:title" content="搭建自己的 Gitlab CI Runner - Randy&#x27;s Blog"><meta data-saber-head="ssr" property="og:type" content="article"><meta data-saber-head="ssr" property="article:published_time" content="2017-04-20 20:17:42"><meta data-saber-head="ssr" property="twitter:title" content="搭建自己的 Gitlab CI Runner - Randy&#x27;s Blog"><meta data-saber-head="ssr" property="og:url" content="https://erwin199.github.io/gitlab-ci-runner"><meta data-saber-head="ssr" property="og:image" content="https://gbstatic.djyde.com/assets/Snapseed%203.jpg?x-oss-process=image/auto-orient,1/quality,q_80/bright,-10/resize,w_2560/contrast,-30/interlace,1"><meta data-saber-head="ssr" property="twitter:image" content="https://gbstatic.djyde.com/assets/Snapseed%203.jpg?x-oss-process=image/auto-orient,1/quality,q_80/bright,-10/resize,w_2560/contrast,-30/interlace,1"> <title>搭建自己的 Gitlab CI Runner - Randy&#x27;s Blog</title> <link data-saber-head="ssr" rel="stylesheet" href="//ppp.djyde.com/css?family=Noto+Serif+SC"><link rel="stylesheet" href="/_saber/css/styles.f7e8e04a.chunk.css">  </head><body><div id="_saber" data-server-rendered="true"><div><div data-v-e0a46de4><nav class="bg-black flex text-white item-center font-serif" data-v-0adf0f64 data-v-e0a46de4><div class="text font-bold mr-4 p-1 pl-4" data-v-0adf0f64><a href="/" class="router-link-active" data-v-0adf0f64>Randy's Blog</a></div> <div class="flex item-center" data-v-0adf0f64><a href="/" class="mr-4 hover:bg-gray-300 hover:text-gray-900 p-1 router-link-active" data-v-0adf0f64>寫作</a></div><div class="flex item-center" data-v-0adf0f64><a href="/readings" class="mr-4 hover:bg-gray-300 hover:text-gray-900 p-1" data-v-0adf0f64>我讀</a></div><div class="flex item-center" data-v-0adf0f64><a href="/music" class="mr-4 hover:bg-gray-300 hover:text-gray-900 p-1" data-v-0adf0f64>音樂</a></div><div class="flex item-center" data-v-0adf0f64><a href="/about" class="mr-4 hover:bg-gray-300 hover:text-gray-900 p-1" data-v-0adf0f64>關於我</a></div></nav> <!----> <div class="post container mx-auto lg:pl-48 lg:pr-48" data-v-e0a46de4><h1 class="pl-4 pr-4" data-v-e0a46de4>搭建自己的 Gitlab CI Runner</h1> <div class="text-sm text-gray-500 pl-4 pr-4" data-v-e0a46de4>April 20, 2017</div> <div class="content" data-v-e0a46de4><blockquote data-v-e0a46de4><p data-v-e0a46de4>假定你已经有一台可用的，可联网的机器</p></blockquote> <h2 id="preface" data-v-e0a46de4>Preface</h2> <p data-v-e0a46de4>这篇文章将介绍如何使用自己的机器来搭建用于 Gitlab CI 的 runner.  在搭建自己的 CI Runner 之前，需要先明确一些概念：</p> <h3 id="ci-continuous-integration" data-v-e0a46de4>CI (Continuous Integration)</h3> <p data-v-e0a46de4>CI 的全称是 Continuous Integration (持续集成)，是 extreme programming (极限编程) 的一部分。我们常用 CI 来做一些自动化工作，这种自动化工作会运行在一台集中的机器上，比如程序的打包，单元测试，部署等。这种构建方式避免了了打包环境差异引动的错误，并且通过 Gitlab 的 hook, 在代码提交的各个环节自动地完成一系列的构建工作。</p> <h3 id="ci-runner" data-v-e0a46de4>CI Runner</h3> <p data-v-e0a46de4>和第三方的 Travis CI, CircleCI 不同，<strong data-v-e0a46de4>Gitlab 本身并不提供机器</strong>，只提供一个注册机器的接口。这些机器用于运行构建逻辑，在 Gitlab 中被称为 Runner.</p> <p data-v-e0a46de4>![runners](<a rel="noopener noreferrer" target="_blank" href="https://gbstatic.djyde.com/assets/006tNc79gy1fet5ffxwglj31ac0y2wj8.jpg" data-v-e0a46de4>https://gbstatic.djyde.com/assets/006tNc79gy1fet5ffxwglj31ac0y2wj8.jpg</a>)</p> <h2 id="gitlab-runner-环境" data-v-e0a46de4>Gitlab Runner 环境</h2> <p data-v-e0a46de4>在这里直接使用 Gitlab Runner 的官方 docker image:</p> <h3 id="安装-docker" data-v-e0a46de4>安装 Docker</h3> <div class="saber-highlight" data-lang="bash" data-v-e0a46de4><pre class="saber-highlight-code language-bash" data-v-e0a46de4><code class="language-bash" data-v-e0a46de4><span class="token function" data-v-e0a46de4>curl</span> -sSL https://get.daocloud.io/docker <span class="token operator" data-v-e0a46de4>|</span> <span class="token function" data-v-e0a46de4>sh</span></code></pre></div><h3 id="拉取-gitlab-runner-镜像" data-v-e0a46de4>拉取 gitlab-runner 镜像</h3> <p data-v-e0a46de4>因为众所周知的原因，国内 pull docker 镜像非常不稳定，所以在这里用 Daocloud 提供的镜像：</p> <div class="saber-highlight" data-lang="bash" data-v-e0a46de4><pre class="saber-highlight-code language-bash" data-v-e0a46de4><code class="language-bash" data-v-e0a46de4><span class="token function" data-v-e0a46de4>curl</span> -sSL https://get.daocloud.io/daotools/set_mirror.sh <span class="token operator" data-v-e0a46de4>|</span> <span class="token function" data-v-e0a46de4>sh</span> -s http://718dbf2d.m.daocloud.io

<span class="token function" data-v-e0a46de4>sudo</span> <span class="token function" data-v-e0a46de4>service</span> docker restart</code></pre></div><p data-v-e0a46de4>拉取镜像：</p> <div class="saber-highlight" data-lang="bash" data-v-e0a46de4><pre class="saber-highlight-code language-bash" data-v-e0a46de4><code class="language-bash" data-v-e0a46de4><span class="token function" data-v-e0a46de4>sudo</span> docker pull gitlab/gitlab-runner:latest</code></pre></div><h3 id="添加-gitlab-runner-container" data-v-e0a46de4>添加 gitlab-runner container</h3> <div class="saber-highlight" data-lang="bash" data-v-e0a46de4><pre class="saber-highlight-code language-bash" data-v-e0a46de4><code class="language-bash" data-v-e0a46de4><span class="token function" data-v-e0a46de4>sudo</span> docker run -d --name gitlab-runner --restart always <span class="token punctuation" data-v-e0a46de4>\</span>
  -v /srv/gitlab-runner/config:/etc/gitlab-runner <span class="token punctuation" data-v-e0a46de4>\</span>
  -v /var/run/docker.sock:/var/run/docker.sock <span class="token punctuation" data-v-e0a46de4>\</span>
  gitlab/gitlab-runner:latest</code></pre></div><h3 id="配置用于-runner-的-docker-image" data-v-e0a46de4>配置用于 runner 的 docker image</h3> <blockquote data-v-e0a46de4><p data-v-e0a46de4>虽然 Gitlab 支持多种 runner 运行方式，但本文建议使用 docker，因为使用 docker 较为灵活，一台机器可以创建多个 docker images 分别为不同的项目进行 CI, 但仍能保持环境隔离。</p></blockquote> <p data-v-e0a46de4>配置 Docker image 最简单的方式是写 <code data-v-e0a46de4>Dockerfile</code>, 比如可以用 Node.js 官方的 Docker image:</p> <div class="saber-highlight" data-lang="dockerfile" data-v-e0a46de4><pre class="saber-highlight-code language-dockerfile" data-v-e0a46de4><code class="language-dockerfile" data-v-e0a46de4><span class="token comment" data-v-e0a46de4># Dockerfile</span>
<span class="token keyword" data-v-e0a46de4>FROM</span> node<span class="token punctuation" data-v-e0a46de4>:</span>7.9.0</code></pre></div><p data-v-e0a46de4>由于每个业务总会有各自的环境要求，比如应用依赖底层的库。这时可以通过 <code data-v-e0a46de4>Dockerfile</code> 配置：</p> <div class="saber-highlight" data-lang="dockerfile" data-v-e0a46de4><pre class="saber-highlight-code language-dockerfile" data-v-e0a46de4><code class="language-dockerfile" data-v-e0a46de4><span class="token comment" data-v-e0a46de4># Dockerfile</span>
<span class="token keyword" data-v-e0a46de4>FROM</span> node<span class="token punctuation" data-v-e0a46de4>:</span>7.9.0

<span class="token keyword" data-v-e0a46de4>RUN</span> apt<span class="token punctuation" data-v-e0a46de4>-</span>get update &amp;&amp; apt<span class="token punctuation" data-v-e0a46de4>-</span>get install <span class="token punctuation" data-v-e0a46de4>-</span>y \
	package<span class="token punctuation" data-v-e0a46de4>-</span>foo
	package<span class="token punctuation" data-v-e0a46de4>-</span>bar</code></pre></div><h3 id="构建-docker-image" data-v-e0a46de4>构建 Docker Image</h3> <p data-v-e0a46de4>写好 <code data-v-e0a46de4>Dockerfile</code> 后，需要把它构建成 Image:</p> <div class="saber-highlight" data-lang="bash" data-v-e0a46de4><pre class="saber-highlight-code language-bash" data-v-e0a46de4><code class="language-bash" data-v-e0a46de4><span class="token function" data-v-e0a46de4>ls</span>
<span class="token comment" data-v-e0a46de4># Dockerfile</span>

docker build -t IMAGE_NAME <span class="token builtin class-name" data-v-e0a46de4>.</span></code></pre></div><p data-v-e0a46de4>Build 完后，通过 <code data-v-e0a46de4>sudo docker image ls</code> 查看 image 状态。</p> <h3 id="注册-runner" data-v-e0a46de4>注册 Runner</h3> <p data-v-e0a46de4>接下来就可以注册 Runner:</p> <div class="saber-highlight" data-lang="bash" data-v-e0a46de4><pre class="saber-highlight-code language-bash" data-v-e0a46de4><code class="language-bash" data-v-e0a46de4><span class="token function" data-v-e0a46de4>sudo</span> docker <span class="token builtin class-name" data-v-e0a46de4>exec</span> -it gitlab-runner gitlab-ci-multi-runner register</code></pre></div><p data-v-e0a46de4>程序会要求你填写相关的信息，这些信息可以从 Gitlab 项目的 <code data-v-e0a46de4>Settings -&gt; Runners</code> 页面中找到：</p> <p data-v-e0a46de4>![Gitlab runner info](<a rel="noopener noreferrer" target="_blank" href="https://gbstatic.djyde.com/assets/006tNc79gy1fetavn7r0lj319u0os78u.jpg" data-v-e0a46de4>https://gbstatic.djyde.com/assets/006tNc79gy1fetavn7r0lj319u0os78u.jpg</a>)</p> <div class="saber-highlight" data-lang="bash" data-v-e0a46de4><pre class="saber-highlight-code language-bash" data-v-e0a46de4><code class="language-bash" data-v-e0a46de4>Please enter the gitlab-ci coordinator URL:
<span class="token comment" data-v-e0a46de4># http://gitlab.alibaba-inc.com/ci</span>

Please enter the gitlab-ci token <span class="token keyword" data-v-e0a46de4>for</span> this runner:
<span class="token comment" data-v-e0a46de4># 项目的 token</span>

Please enter the gitlab-ci description <span class="token keyword" data-v-e0a46de4>for</span> this runner:
<span class="token comment" data-v-e0a46de4># Runner 的 description</span>

Please enter the gitlab-ci tags <span class="token keyword" data-v-e0a46de4>for</span> this runner <span class="token punctuation" data-v-e0a46de4>(</span>comma separated<span class="token punctuation" data-v-e0a46de4>)</span>:
<span class="token comment" data-v-e0a46de4># Runner 的 tag</span>

Whether to run untagged builds <span class="token punctuation" data-v-e0a46de4>[</span>true/false<span class="token punctuation" data-v-e0a46de4>]</span>:
<span class="token comment" data-v-e0a46de4># true</span>

Please enter the executor: docker, parallels, shell, kubernetes, docker-ssh, ssh, virtualbox, docker+machine, docker-ssh+machine:
<span class="token comment" data-v-e0a46de4># docker</span>

Please enter the default Docker image <span class="token punctuation" data-v-e0a46de4>(</span>e.g. ruby:2.1<span class="token punctuation" data-v-e0a46de4>)</span>:
<span class="token comment" data-v-e0a46de4># 填入构建 Docker image 时填写的 image 名称</span></code></pre></div><p data-v-e0a46de4>这时 runner 就会出现在 <code data-v-e0a46de4>runners</code> 页面：</p> <p data-v-e0a46de4><img src="https://gbstatic.djyde.com/assets/006tNc79gy1fetbnh1e12j310008qdgs.jpg" alt="" data-v-e0a46de4></p> <h2 id="faq" data-v-e0a46de4>FAQ</h2> <h3 id="ci-运行时出现-error-job-failed-api-error-404-repository-xxx-not-found-does-not-exist-or-no-pull-access" data-v-e0a46de4>CI 运行时出现 <code data-v-e0a46de4>ERROR: Job failed: API error (404): repository xxx not found: does not exist or no pull access</code></h3> <p data-v-e0a46de4>这是由于 Gitlab 会默认从远程拉取 image，而我们的 image 是在本地构建的，所以需要对 gitlab-runner 进行配置，把 <code data-v-e0a46de4>pull_policy</code> 设置为 <code data-v-e0a46de4>if-not-present</code> 或 <code data-v-e0a46de4>never</code>.</p> <div class="saber-highlight" data-lang="bash" data-v-e0a46de4><pre class="saber-highlight-code language-bash" data-v-e0a46de4><code class="language-bash" data-v-e0a46de4><span class="token comment" data-v-e0a46de4># 进入 gitlab-runner 的 bash 环境</span>
<span class="token function" data-v-e0a46de4>sudo</span> docker <span class="token builtin class-name" data-v-e0a46de4>exec</span> -it gitlab-runner <span class="token function" data-v-e0a46de4>bash</span>

<span class="token comment" data-v-e0a46de4># 编辑 config.toml</span>
<span class="token function" data-v-e0a46de4>nano</span> /etc/gitlab-runner/config.toml</code></pre></div><p data-v-e0a46de4>编辑 <code data-v-e0a46de4>config.toml</code> 中对应的 runner:</p> <div class="saber-highlight" data-lang="diff" data-v-e0a46de4><pre class="saber-highlight-code language-diff" data-v-e0a46de4><code class="language-diff" data-v-e0a46de4>[[runners]]
<span class="token unchanged" data-v-e0a46de4>  name = &quot;&quot;
  url = &quot;&quot;
  token = &quot;&quot;
  executor = &quot;docker&quot;
  [runners.docker]
    tls_verify = false
    image = &quot;nb-node&quot;
    privileged = false
    disable_cache = false
    volumes = [&quot;/cache&quot;]
</span><span class="token inserted-sign inserted" data-v-e0a46de4>+   pull_policy = &quot;if-not-present&quot;
</span><span class="token unchanged" data-v-e0a46de4>  [runners.cache]
</span></code></pre></div><h2 id="延伸阅读" data-v-e0a46de4>延伸阅读</h2> <ul data-v-e0a46de4><li data-v-e0a46de4><a rel="noopener noreferrer" target="_blank" href="https://docs.gitlab.com/runner/install/docker.html" data-v-e0a46de4>Run GitLab Runner in a container</a></li> <li data-v-e0a46de4><a rel="noopener noreferrer" target="_blank" href="https://www.daocloud.io/mirror#accelerator-doc" data-v-e0a46de4>配置 Docker 加速器</a></li> <li data-v-e0a46de4><a rel="noopener noreferrer" target="_blank" href="https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/" data-v-e0a46de4>Best practices for writing Dockerfiles</a></li> <li data-v-e0a46de4><a rel="noopener noreferrer" target="_blank" href="https://docs.gitlab.com/runner/executors/docker.html#using-the-if-not-present-pull-policy" data-v-e0a46de4>Using the if-not-present pull policy</a></li></ul></div></div> <div class="post text-center text-sm" data-v-e0a46de4><hr class="mt-12 mb-12" data-v-e0a46de4> <p data-v-e0a46de4>讨论请发邮件到 randypriv@gmail.com</p> <p data-v-e0a46de4>未经授权，禁止转载</p> <p data-v-e0a46de4>通过支付宝 djyde520@gmail.com 或赞赏码赞助此文</p> <p data-v-e0a46de4>
      或通过订阅我的
      <a href="/blog/my-zsxq/" data-v-e0a46de4 data-v-e0a46de4>知识星球</a>支持本博客
    </p> <br data-v-e0a46de4> <p data-v-e0a46de4><img src="https://gbstatic.djyde.com/assets/006tKfTcgy1fkuufy2cadj30w00w0tb2.jpg" class="w-auto sm:w-64 mx-auto" data-v-e0a46de4></p></div></div> <div class="font-serif text-sm text-center p-12 sm:p-32 text-gray-500 font-bold"><div>
      2014-2019
      <a href="/" class="router-link-active">Randy's Blog</a></div> <div class="mt-2">
      可通過
      <a href="/rss.xml" class="border-b-4">RSS</a> 或
      <a rel="noopener noreferrer" target="_blank" href="https://tinyletter.com/randysblog" class="border-b-4">Email</a> 訂閱本博客
    </div></div></div></div><script src="/_saber/js/styles.f7e8e04a.js" defer></script><script src="/_saber/js/page--_posts-gitlab-ci-runner-md.13188440.js" defer></script><script src="/_saber/js/client.33334454.js" defer></script></body></html>
